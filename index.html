<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>ConformScan ‚Äì Network Scan RGPD / ISO 27001</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --primary: #21354c;
      --secondary: #4096ff;
      --danger: #e63946;
      --warning: #ffbe0b;
      --success: #3bb273;
      --bg: #f7fafd;
    }
    body {
      background: var(--bg);
      color: var(--primary);
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0; padding: 0;
    }
    .main {
      max-width: 600px;
      margin: 36px auto 32px auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 40px #0001;
      padding: 32px 22px 32px 22px;
    }
    h1 { font-size: 2.2rem; margin-top: 0; color: var(--primary); }
    label { display: block; margin-top: 16px; font-weight: 500; }
    input, button {
      padding: 12px; font-size: 1.05rem; width: 100%; margin-top: 8px;
      border-radius: 7px; border: 1px solid #e0e5ec;
      margin-bottom: 6px;
    }
    input:focus { border: 1.5px solid var(--secondary); outline: none; }
    button {
      background: var(--secondary); color: #fff; border: none;
      font-weight: 600; cursor: pointer;
      transition: background 0.18s;
      margin-top: 12px;
    }
    button:hover { background: var(--primary); }
    table { border-collapse: collapse; width: 100%; margin-top: 14px; }
    th, td {
      border: 1px solid #e5e7eb; padding: 10px; text-align: left;
      background: #fcfcff;
    }
    th { background: #f1f4fa; }
    .ports { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip {
      display: inline-block; padding: 4px 12px; border-radius: 999px;
      background: #e3eaff; color: var(--primary); font-size: 14px;
      font-weight: 500; margin-right: 4px;
    }
    .chip-critical { background: var(--danger); color: #fff; }
    .chip-high     { background: var(--warning); color: #fff; }
    .chip-low      { background: var(--success); color: #fff; }
    .legend { margin-top:4px; font-size: 13px; color:#888; }
    .card {
      border: none; background: #fff;
      box-shadow: 0 4px 24px #0001;
      border-radius: 12px; padding: 24px; margin-top: 24px;
    }
    .sev { font-weight: bold; margin-top: 8px; }
    .sev-high { color: var(--danger); }
    .sev-med  { color: var(--warning); }
    .sev-low  { color: var(--success); }
    ul { margin: 8px 0 0 18px; }
    #downloadBtn { display: none; margin-top: 16px; padding: 12px 18px;
      background: var(--primary); color: #fff; text-decoration: none;
      border-radius: 8px; width: auto; font-size:1.1rem; }
    #msg { margin-top: 16px; }
    .lang-switch {
      background: #fff; border-radius: 6px; border: 1px solid #e5e7eb;
      box-shadow: 0 4px 18px #0002;
      font-weight: bold; font-size: 1rem;
      padding: 6px 16px;
      cursor: pointer;
      color: #21354c;
      margin-left: 12px;
      margin-right: 2px;
      min-width: 50px;
    }
    @media (max-width:600px) {
      .main { padding: 14px 3vw; }
      h1 { font-size:1.4rem; }
      .card { padding: 10px 4vw;}
      .lang-switch { padding: 6px 10px; font-size: 0.98rem; min-width:40px; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- HEADER avec s√©lecteur de langue √† droite -->
  <header style="background:linear-gradient(90deg, #4096ff 0%, #21354c 100%); color:white; padding:28px 0 20px 0; border-radius: 0 0 16px 16px; margin-bottom:26px; box-shadow:0 8px 32px #0003;">
    <div style="display:flex; align-items:center; justify-content:space-between; max-width:680px; margin:auto; gap:18px;">
      <div style="display:flex; align-items:center; gap:18px;">
        <img src="logo_conformscan.png" alt="Logo" style="height:56px;">
        <span style="font-size:2.2rem;font-weight:bold;letter-spacing:1px;" id="txtTitle">ConformScan</span>
      </div>
      <button class="lang-switch" id="langSwitch" onclick="toggleLang()">EN</button>
    </div>
    <div id="txtSubtitle" style="text-align:center;margin-top:8px;font-size:1.1rem;font-weight:400;opacity:0.7">
      Scanner RGPD & ISO 27001 pour PME
    </div>
  </header>
  <div class="main">
    <h1 id="txtLoginTitle">üîê Connexion</h1>
    <label id="lblEmail">Email</label>
    <input type="text" id="email" value="admin@conformscan.ch" />
    <label id="lblPwd">Mot de passe</label>
    <input type="password" id="password" value="admin123" />
    <button onclick="login()" id="btnLogin">Connexion</button>
    <hr>
    <h2 style="margin-top:32px;" id="txtCreateAccount">Cr√©er un compte</h2>
    <label id="lblRegEmail">Nouvel Email</label>
    <input type="text" id="reg_email" placeholder="Entrez votre email" />
    <label id="lblRegPwd">Mot de passe</label>
    <input type="password" id="reg_password" placeholder="Entrez un mot de passe" />
    <button onclick="register()" id="btnRegister">Inscription</button>
    <hr>
    <h1 id="txtScanTitle">üñ•Ô∏è Scan R√©seau</h1>
    <label id="lblScanIP">Adresse IP √† scanner (optionnel)</label>
    <input type="text" id="target" placeholder="ex: 172.20.10.5" />
    <label id="lblScanRange">Plage d‚ÄôIP √† scanner (optionnel, ex: 192.168.1.1-192.168.1.5)</label>
    <input type="text" id="range" placeholder="ex: 192.168.1.1-192.168.1.5" />
    <button onclick="launchScan()" id="btnScan">Lancer le Scan</button>
    <div id="msg"></div>
    <a id="downloadBtn" href="#" download target="_blank">üìÑ <span id="txtDownload">T√©l√©charger le rapport PDF</span></a>
    <div id="result"></div>
    <div class="card">
      <h3 id="txtChartTitle">üìä Ports ouverts par criticit√©</h3>
      <canvas id="chartPorts" height="100"></canvas>
    </div>
    <div id="recoBox"></div>
  </div>
  <script>
    // ======== API URL CONFIGURATION ========
    const API_URL = "https://conformscan.onrender.com";
    // ======== FIN CONFIGURATION API ========

    // --- Textes FR/EN ---
    const translations = {
      fr: {
        title: "ConformScan",
        subtitle: "Scanner RGPD & ISO 27001 pour PME",
        loginTitle: "üîê Connexion",
        email: "Email",
        pwd: "Mot de passe",
        btnLogin: "Connexion",
        createAccount: "Cr√©er un compte",
        regEmail: "Nouvel Email",
        regPwd: "Mot de passe",
        btnRegister: "Inscription",
        scanTitle: "üñ•Ô∏è Scan R√©seau",
        scanIP: "Adresse IP √† scanner (optionnel)",
        scanRange: "Plage d‚ÄôIP √† scanner (optionnel, ex: 192.168.1.1-192.168.1.5)",
        btnScan: "Lancer le Scan",
        download: "T√©l√©charger le rapport PDF",
        chartTitle: "üìä Ports ouverts par criticit√©",
        msgMissing: "Email ou mot de passe manquant.",
        msgRegistering: "Cr√©ation du compte en cours...",
        msgRegistered: "‚úÖ Inscription r√©ussie, connectez-vous maintenant.",
        msgExists: "‚ùå Utilisateur d√©j√† existant.",
        msgLoginOK: "‚úÖ Connect√© avec succ√®s.",
        msgLoginFail: "‚ùå Connexion √©chou√©e.",
        msgAuthMissing: "‚ö†Ô∏è Authentification ou IP/plage manquante.",
        msgScanLoading: "üîç Scan en cours...",
        msgScanDone: "‚úÖ Scan termin√© avec succ√®s.",
        msgScanError: "‚ùå Erreur lors du scan",
        tableIP: "IP Scann√©e",
        tablePorts: "Ports Ouverts",
        tableRisk: "Score de Risque",
        tableStatus: "Statut",
        legendRed: "Rouge = port critique",
        blockHigh: "√âlev√©e",
        blockMed: "Moyenne",
        blockLow: "Faible",
        blockReco: "üìå Recommandations class√©es"
      },
      en: {
        title: "ConformScan",
        subtitle: "GDPR & ISO 27001 Network Scanner for SMEs",
        loginTitle: "üîê Login",
        email: "Email",
        pwd: "Password",
        btnLogin: "Login",
        createAccount: "Create an account",
        regEmail: "New email",
        regPwd: "Password",
        btnRegister: "Sign up",
        scanTitle: "üñ•Ô∏è Network Scan",
        scanIP: "IP address to scan (optional)",
        scanRange: "IP range to scan (optional, e.g. 192.168.1.1-192.168.1.5)",
        btnScan: "Run Scan",
        download: "Download PDF report",
        chartTitle: "üìä Open ports by criticality",
        msgMissing: "Missing email or password.",
        msgRegistering: "Creating your account...",
        msgRegistered: "‚úÖ Successfully registered, please log in.",
        msgExists: "‚ùå User already exists.",
        msgLoginOK: "‚úÖ Login successful.",
        msgLoginFail: "‚ùå Login failed.",
        msgAuthMissing: "‚ö†Ô∏è Authentication or IP/range missing.",
        msgScanLoading: "üîç Scanning...",
        msgScanDone: "‚úÖ Scan completed successfully.",
        msgScanError: "‚ùå Scan error",
        tableIP: "Scanned IP",
        tablePorts: "Open Ports",
        tableRisk: "Risk Score",
        tableStatus: "Status",
        legendRed: "Red = critical port",
        blockHigh: "High",
        blockMed: "Medium",
        blockLow: "Low",
        blockReco: "üìå Recommendations by criticality"
      }
    };

    let lang = localStorage.getItem("lang") || "fr";
    function setLang(newLang) {
      lang = newLang;
      localStorage.setItem("lang", lang);
      const t = translations[lang];
      document.getElementById("langSwitch").textContent = lang === "fr" ? "EN" : "FR";
      document.getElementById("txtTitle").textContent = t.title;
      document.getElementById("txtSubtitle").textContent = t.subtitle;
      document.getElementById("txtLoginTitle").textContent = t.loginTitle;
      document.getElementById("lblEmail").textContent = t.email;
      document.getElementById("lblPwd").textContent = t.pwd;
      document.getElementById("btnLogin").textContent = t.btnLogin;
      document.getElementById("txtCreateAccount").textContent = t.createAccount;
      document.getElementById("lblRegEmail").textContent = t.regEmail;
      document.getElementById("lblRegPwd").textContent = t.regPwd;
      document.getElementById("btnRegister").textContent = t.btnRegister;
      document.getElementById("txtScanTitle").textContent = t.scanTitle;
      document.getElementById("lblScanIP").textContent = t.scanIP;
      document.getElementById("lblScanRange").textContent = t.scanRange;
      document.getElementById("btnScan").textContent = t.btnScan;
      document.getElementById("txtDownload").textContent = t.download;
      document.getElementById("txtChartTitle").textContent = t.chartTitle;
    }
    function toggleLang() { setLang(lang === "fr" ? "en" : "fr"); }
    window.onload = () => { setLang(lang); };

    let token = localStorage.getItem("token") || "";
    let chart; // Chart.js global

    async function login() {
      const t = translations[lang];
      const res = await fetch(API_URL + '/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          username: document.getElementById("email").value,
          password: document.getElementById("password").value,
          grant_type: "password"
        })
      });
      const data = await res.json();
      if (res.ok && data.access_token) {
        token = data.access_token;
        localStorage.setItem("token", token);
        document.getElementById("msg").textContent = t.msgLoginOK;
      } else {
        document.getElementById("msg").textContent = t.msgLoginFail;
      }
    }

    async function register() {
      const t = translations[lang];
      const email = document.getElementById("reg_email").value.trim();
      const password = document.getElementById("reg_password").value.trim();
      if (!email || !password) {
        document.getElementById("msg").textContent = t.msgMissing;
        return;
      }
      document.getElementById("msg").textContent = t.msgRegistering;
      const res = await fetch(API_URL + '/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: email, password: password })
      });
      let data = await res.json();
      if (res.ok) {
        document.getElementById("msg").textContent = t.msgRegistered;
      } else if(data.detail && data.detail.includes("d√©j√† existant")) {
        document.getElementById("msg").textContent = t.msgExists;
      } else {
        document.getElementById("msg").textContent = "‚ùå " + (data.detail || JSON.stringify(data));
      }
    }

    async function launchScan() {
      const t = translations[lang];
      const ip = document.getElementById("target").value.trim();
      const ip_range = document.getElementById("range").value.trim();
      if (!token || (!ip && !ip_range)) {
        document.getElementById("msg").textContent = t.msgAuthMissing;
        return;
      }
      document.getElementById("msg").textContent = t.msgScanLoading;

      const body = ip
        ? { target: ip }
        : { ip_range: ip_range };

      const res = await fetch(API_URL + '/scan', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(body)
      });

      let data;
      try {
        data = await res.json();
      } catch (e) {
        document.getElementById("msg").textContent = `‚ùå R√©ponse non JSON (code ${res.status})`;
        return;
      }
      if (!res.ok) {
        document.getElementById("msg").textContent = `${t.msgScanError}: ${data.detail || JSON.stringify(data)}`;
        return;
      }
      document.getElementById("msg").textContent = t.msgScanDone;

      // --- Affichage r√©sultat PLAGE ---
      if (data.plage_results && Array.isArray(data.plage_results)) {
        let html = data.plage_results.map(ipData => {
          const critical = new Set(ipData.critical_ports || []);
          const chips = (ipData.open_ports || []).map(p => {
            let cls = 'chip';
            if (critical.has(p)) cls += ' chip-critical';
            return `<span class="${cls}">${p}</span>`;
          }).join('');
          return `
          <table>
            <tr>
              <th>${t.tableIP}</th>
              <th>${t.tablePorts}</th>
              <th>${t.tableRisk}</th>
              <th>${t.tableStatus}</th>
            </tr>
            <tr>
              <td>${ipData.scanned_ip}</td>
              <td><div class="ports">${chips}</div><div class="legend">${t.legendRed}</div></td>
              <td>${ipData.risk_score}</td>
              <td>${ipData.status}</td>
            </tr>
          </table>
          `;
        }).join("<br>");
        document.getElementById("result").innerHTML = html;
        document.getElementById("recoBox").innerHTML = "";
        // MAJ graphique (somme sur toute la plage)
        let critical=0, high=0, low=0;
        data.plage_results.forEach(ipData => {
          (ipData.recommendations || []).forEach(r => {
            if(r.severity === "√©lev√©e") critical++;
            else if(r.severity === "moyenne") high++;
            else low++;
          });
        });
        updateChart(critical, high, low, t);
        if (data.report_link) {
          const btn = document.getElementById("downloadBtn");
          btn.href = data.report_link;
          btn.style.display = "inline-block";
        }
        return;
      }

      // --- Affichage r√©sultat IP UNIQUE ---
      const critical = new Set(data.critical_ports || []);
      const chips = (data.open_ports || []).map(p => {
        let cls = 'chip';
        if (critical.has(p)) cls += ' chip-critical';
        return `<span class="${cls}">${p}</span>`;
      }).join('');
      document.getElementById("result").innerHTML = `
        <table>
          <tr>
            <th>${t.tableIP}</th>
            <th>${t.tablePorts}</th>
            <th>${t.tableRisk}</th>
            <th>${t.tableStatus}</th>
          </tr>
          <tr>
            <td>${data.scanned_ip}</td>
            <td><div class="ports">${chips}</div><div class="legend">${t.legendRed}</div></td>
            <td>${data.risk_score}</td>
            <td>${data.status}</td>
          </tr>
        </table>
      `;
      // MAJ graphique pour IP unique
      let c=0, h=0, l=0;
      (data.recommendations || []).forEach(r => {
        if(r.severity === "√©lev√©e") c++;
        else if(r.severity === "moyenne") h++;
        else l++;
      });
      updateChart(c, h, l, t);

      // Recommandations class√©es
      const groups = { "√©lev√©e": [], "moyenne": [], "faible": [] };
      (data.recommendations || []).forEach(r => {
        if (groups[r.severity]) groups[r.severity].push(r);
      });
      const block = (title, cls, items) => {
        if (!items.length) return "";
        const lis = items.map(i => `<li>Port ${i.port} (${i.service}) ‚Äî ${i.text}</li>`).join("");
        return `<div class="sev ${cls}">${title} (${items.length})</div><ul>${lis}</ul>`;
      };
      document.getElementById("recoBox").innerHTML = `
        <div class="card">
          <h3>${t.blockReco}</h3>
          ${block(t.blockHigh, "sev-high", groups["√©lev√©e"])}
          ${block(t.blockMed, "sev-med",  groups["moyenne"])}
          ${block(t.blockLow,  "sev-low",  groups["faible"])}
        </div>
      `;
      if (data.report_link) {
        const btn = document.getElementById("downloadBtn");
        btn.href = data.report_link;
        btn.style.display = "inline-block";
      }
    }

    function updateChart(critical, high, low, t) {
      const ctx = document.getElementById("chartPorts").getContext("2d");
      if(window._chart) window._chart.destroy();
      window._chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: [t.blockHigh, t.blockMed, t.blockLow],
          datasets: [{
            data: [critical, high, low],
            backgroundColor: ["#e63946", "#ffbe0b", "#3bb273"],
            borderWidth: 1
          }]
        },
        options: {
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }
  </script>
</body>
</html>
