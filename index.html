<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>ConformScan ‚Äì Interface Web</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; max-width: 900px; }
    h1 { color: #2c3e50; }
    label { display: block; margin-top: 14px; }
    input, button { padding: 10px; width: 100%; margin-top: 6px; }
    table { border-collapse: collapse; width: 100%; margin-top: 16px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background-color: #f7f7f7; }
    #downloadBtn { display: none; margin-top: 12px; padding: 10px; background: #11823b; color: #fff; text-decoration: none; border-radius: 6px; width: auto; }
    #msg { margin-top: 12px; }
    .ports { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip { display:inline-block; padding: 4px 10px; border-radius: 999px; border: 1px solid #d1d5db; background:#f3f4f6; font-size: 13px; }
    .chip-critical { border-color:#ef4444; background:#fee2e2; color:#b91c1c; font-weight: 600; }
    .card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 14px; margin-top: 16px; background:#fafafa; }
    .sev { font-weight: bold; margin-top: 8px; }
    .sev-high { color: #b91c1c; }
    .sev-med  { color: #b45309; }
    .sev-low  { color: #065f46; }
    ul { margin: 8px 0 0 18px; }
    .legend { margin-top:8px; font-size: 12px; color:#6b7280; }
  </style>
</head>
<body>

  <h1>üîê ConforScan Connexion</h1>
  <label>Email</label>
  <input type="text" id="email" value="admin@conformscan.ch" />
  <label>Mot de passe</label>
  <input type="password" id="password" value="admin123" />
  <button onclick="login()">Connexion</button>

  <hr>

  <h1>üñ•Ô∏è Scan R√©seau</h1>
  <label>Adresse IP √† scanner</label>
  <input type="text" id="target" placeholder="ex: 172.20.10.5" />
  <button onclick="launchScan()">Lancer le Scan</button>

  <div id="msg"></div>
  <a id="downloadBtn" href="#" download target="_blank">üìÑ T√©l√©charger le rapport</a>

  <div id="result"></div>
  <div id="recoBox"></div>

  <script>
    // --- METTRE L'URL DE TON BACKEND EN PRODUCTION ---
    const API_URL = "https://conformscan.onrender.com";
    // Pour test en local, mets : const API_URL = "http://127.0.0.1:8000";

    let token = localStorage.getItem("token") || "";

    async function login() {
      const res = await fetch(API_URL + '/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          username: document.getElementById("email").value,
          password: document.getElementById("password").value,
          grant_type: "password"
        })
      });
      const data = await res.json();
      if (res.ok && data.access_token) {
        token = data.access_token;
        localStorage.setItem("token", token);
        document.getElementById("msg").textContent = "‚úÖ Connect√© avec succ√®s.";
      } else {
        document.getElementById("msg").textContent = "‚ùå Connexion √©chou√©e.";
      }
    }

    async function launchScan() {
      const ip = document.getElementById("target").value.trim();
      if (!token || !ip) {
        document.getElementById("msg").textContent = "‚ö†Ô∏è Authentification ou IP manquante.";
        return;
      }

      document.getElementById("msg").textContent = "üîç Scan en cours...";
      const res = await fetch(API_URL + '/scan', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ target: ip })
      });

      let data;
      try {
        data = await res.json();
      } catch (e) {
        document.getElementById("msg").textContent = `‚ùå R√©ponse non JSON (code ${res.status})`;
        return;
      }

      if (!res.ok) {
        document.getElementById("msg").textContent = `‚ùå Erreur lors du scan : ${data.detail || JSON.stringify(data)}`;
        return;
      }

      document.getElementById("msg").textContent = "‚úÖ Scan termin√© avec succ√®s.";

      const critical = new Set(data.critical_ports || []);
      const chips = (data.open_ports || []).map(p => {
        const cls = critical.has(p) ? 'chip chip-critical' : 'chip';
        return `<span class="${cls}">${p}</span>`;
      }).join('');

      document.getElementById("result").innerHTML = `
        <table>
          <tr><th>IP Scann√©e</th><th>Ports Ouverts</th><th>Score de Risque</th><th>Statut</th></tr>
          <tr>
            <td>${data.scanned_ip}</td>
            <td><div class="ports">${chips}</div><div class="legend">Rouge = port critique</div></td>
            <td>${data.risk_score}</td>
            <td>${data.status}</td>
          </tr>
        </table>
      `;

      const groups = { "√©lev√©e": [], "moyenne": [], "faible": [] };
      (data.recommendations || []).forEach(r => {
        if (groups[r.severity]) groups[r.severity].push(r);
      });
      const block = (title, cls, items) => {
        if (!items.length) return "";
        const lis = items.map(i => `<li>Port ${i.port} (${i.service}) ‚Äî ${i.text}</li>`).join("");
        return `<div class="sev ${cls}">${title} (${items.length})</div><ul>${lis}</ul>`;
      };
      document.getElementById("recoBox").innerHTML = `
        <div class="card">
          <h3>üìå Recommandations class√©es</h3>
          ${block("√âlev√©e", "sev-high", groups["√©lev√©e"])}
          ${block("Moyenne", "sev-med",  groups["moyenne"])}
          ${block("Faible",  "sev-low",  groups["faible"])}
        </div>
      `;

      if (data.report_link) {
        const btn = document.getElementById("downloadBtn");
        // Si report_link commence par '/', pr√©fixe avec API_URL pour le t√©l√©chargement direct
        btn.href = data.report_link.startsWith('/')
          ? API_URL + data.report_link
          : data.report_link;
        btn.style.display = "inline-block";
      }
    }
  </script>
</body>
</html>
